<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIFA IMPERD√çVEL - Concorra a R$200,00</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* =========================================
           Vari√°veis de Cores e Estilo
           ========================================= */
        :root {
            --cor-fundo: #f8f9fa;
            --cor-primaria-azul: #007bff;
            --cor-secundaria-verde: #28a745;
            --cor-alerta-amarelo: #ffc107;
            --cor-texto-escuro: #333333;
            --cor-texto-claro: #6c757d;
            --cor-branco: #ffffff;
            --borda-raio: 12px;
            --sombra-leve: 0 4px 10px rgba(0, 0, 0, 0.08);
            --sombra-hover: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--cor-fundo); color: var(--cor-texto-escuro); padding-bottom: 90px; }

        /* =========================================
           Tela de Carregamento (Bloqueio Inicial)
           ========================================= */
        .tela-carregamento {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--cor-fundo); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            border: 4px solid #e2e8f0; border-top: 4px solid var(--cor-primaria-azul);
            border-radius: 50%; width: 40px; height: 40px;
            animation: girar 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes girar { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* =========================================
           Cabe√ßalho
           ========================================= */
        header {
            background-color: var(--cor-branco); text-align: center;
            padding: 20px 20px; box-shadow: var(--sombra-leve);
            border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
        }
        h1 { color: var(--cor-primaria-azul); font-size: 1.8rem; font-weight: 900; letter-spacing: 1px; }

        /* =========================================
           Container Principal e Banner Imagem
           ========================================= */
        main { max-width: 800px; margin: 0 auto; padding: 0 15px; }

        .container-banner { margin: 20px 0; text-align: center; }
        .imagem-banner {
            width: 100%; height: auto; max-height: 400px;
            border-radius: var(--borda-raio); box-shadow: var(--sombra-leve);
            object-fit: cover; display: block;
        }

        /* Legenda de Cores */
        .legenda { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .item-legenda { display: flex; align-items: center; font-size: 0.85rem; font-weight: 600; color: var(--cor-texto-claro); }
        .bolinha { width: 12px; height: 12px; border-radius: 50%; margin-right: 6px; }
        .bolinha.livre { background-color: var(--cor-branco); border: 2px solid #e2e8f0; }
        .bolinha.selecionado { background-color: var(--cor-secundaria-verde); }
        .bolinha.reservado { background-color: var(--cor-alerta-amarelo); }
        .bolinha.pago { background-color: #cbd5e1; }

        .grid-numeros { display: grid; grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); gap: 10px; justify-content: center; }

        /* Bot√µes de N√∫meros */
        .numero {
            background-color: var(--cor-branco); border: 2px solid #e2e8f0;
            color: var(--cor-texto-escuro); font-size: 1.1rem; font-weight: 700;
            padding: 15px 0; border-radius: 8px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.2s ease;
            appearance: none; outline: none;
        }
        .numero.livre:hover { border-color: var(--cor-primaria-azul); color: var(--cor-primaria-azul); transform: translateY(-2px); }
        .numero.selecionado { background-color: var(--cor-secundaria-verde); border-color: var(--cor-secundaria-verde); color: var(--cor-branco); transform: translateY(-2px); box-shadow: var(--sombra-hover); }
        .numero.reservado { background-color: #fff3cd; border-color: #ffeeba; color: #856404; cursor: not-allowed; }
        .numero.pago { background-color: #e2e8f0; border-color: #cbd5e1; color: #94a3b8; cursor: not-allowed; text-decoration: line-through; box-shadow: none; }

        /* =========================================
           Barra Inferior Fixa
           ========================================= */
        .barra-inferior {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: var(--cor-branco); box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.08);
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            border-top-left-radius: 20px; border-top-right-radius: 20px; z-index: 1000;
        }
        .resumo-selecao { display: flex; flex-direction: column; }
        .resumo-valor { font-size: 1.1rem; font-weight: 800; color: var(--cor-primaria-azul); }
        .btn-primario {
            background-color: var(--cor-secundaria-verde); color: var(--cor-branco); border: none; padding: 14px 24px;
            font-size: 1rem; font-weight: 700; border-radius: 30px; cursor: pointer; box-shadow: var(--sombra-leve); transition: 0.2s ease;
        }
        .btn-primario:hover { background-color: #218838; transform: scale(1.02); }
        .btn-primario:disabled { background-color: #6c757d; cursor: not-allowed; transform: none; }

        /* =========================================
           Estilos do Modal (Checkout)
           ========================================= */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); display: none;
            justify-content: center; align-items: center; z-index: 2000;
            backdrop-filter: blur(3px); padding: 15px;
        }
        .modal-overlay.ativo { display: flex; }
        .modal-content {
            background-color: var(--cor-branco); width: 100%; max-width: 420px;
            border-radius: var(--borda-raio); box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            overflow: hidden; animation: deslizar 0.3s ease-out; position: relative;
        }
        @keyframes deslizar { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #f1f5f9; }
        .modal-header h3 { color: var(--cor-primaria-azul); font-size: 1.2rem; }
        .btn-fechar { background: none; border: none; font-size: 1.8rem; color: var(--cor-texto-claro); cursor: pointer; }
        .modal-body { padding: 20px; }
        .input-group { margin-bottom: 15px; display: flex; flex-direction: column; }
        .input-group label { font-size: 0.9rem; font-weight: 700; margin-bottom: 5px; }
        .input-group input { padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; outline: none; }
        .input-group input:focus { border-color: var(--cor-primaria-azul); }

        /* Estilos do Passo 2 (Pagamento) */
        .box-resumo { background-color: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center; border: 1px solid #e2e8f0; }
        .box-resumo h4 { color: var(--cor-texto-claro); font-size: 0.9rem; margin-bottom: 5px; }
        .box-resumo .valor-destaque { font-size: 1.8rem; color: var(--cor-secundaria-verde); font-weight: 900; }
        .box-pix { background-color: #fff3cd; border: 2px dashed #ffeeba; border-radius: 8px; padding: 15px; text-align: center; margin-bottom: 20px; }
        .box-pix p { font-size: 0.9rem; color: #856404; margin-bottom: 10px; font-weight: bold; }
        .chave-pix { font-family: monospace; font-size: 1.1rem; background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #ffeeba; margin-bottom: 10px; word-break: break-all; }
        .btn-copiar { background-color: #ffc107; color: #000; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .btn-copiar:hover { background-color: #e0a800; }

        .passo { display: none; }
        .passo.ativo { display: block; }
        .btn-voltar-passo { background: none; border: none; color: var(--cor-texto-claro); text-decoration: underline; cursor: pointer; margin-top: 15px; width: 100%; text-align: center; }

        @media (min-width: 768px) {
            header, .barra-inferior { max-width: 800px; margin: 0 auto; }
            header { margin-top: 20px; border-radius: var(--borda-raio); }
            .barra-inferior { left: 50%; transform: translateX(-50%); border-radius: var(--borda-raio) var(--borda-raio) 0 0; }
        }
    </style>
</head>
<body>

    <div id="telaCarregamento" class="tela-carregamento">
        <div class="spinner"></div>
        <p style="font-weight: bold; color: var(--cor-texto-escuro);">Preparando Rifa...</p>
    </div>

    <header>
        <h1>RIFA IMPERD√çVEL</h1>
    </header>

    <main>
        <div class="container-banner">
            <img src="banner.png" alt="Banner da Rifa" class="imagem-banner" id="bannerImagem">
            
            <p style="font-size: 0.8rem; color: #999; margin-top: 5px;">*Para trocar o banner, edite o c√≥digo HTML na linha do img src="..."</p>
        </div>

        <div class="legenda">
            <div class="item-legenda"><div class="bolinha livre"></div> Livre</div>
            <div class="item-legenda"><div class="bolinha reservado"></div> Reservado</div>
            <div class="item-legenda"><div class="bolinha pago"></div> Pago</div>
        </div>

        <div class="grid-numeros" id="gridNumeros">
            </div>
    </main>

    <footer class="barra-inferior">
        <div class="resumo-selecao">
            <span class="resumo-valor" id="totalSelecionado">0 n√∫meros | R$ 0,00</span>
        </div>
        <button class="btn-primario" id="btnAbrirModal">Comprar</button>
    </footer>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitulo">Finalizar Reserva</h3>
                <button class="btn-fechar" id="fecharModal">&times;</button>
            </div>
            
            <div class="modal-body">
                <div id="passo1" class="passo ativo">
                    <p style="color: #6c757d; margin-bottom: 15px; font-size: 0.95rem;">Preencha seus dados para garantir seus n√∫meros.</p>
                    <div class="input-group">
                        <label for="nomeCliente">Nome completo</label>
                        <input type="text" id="nomeCliente" placeholder="Como devemos te chamar?" required>
                    </div>
                    <div class="input-group">
                        <label for="telefoneCliente">WhatsApp</label>
                        <input type="tel" id="telefoneCliente" placeholder="(88) 90000-0000" maxlength="15" required>
                    </div>
                    <button class="btn-primario" style="width: 100%; margin-top: 10px;" id="btnAvancarPagamento">Ir para Pagamento</button>
                </div>

                <div id="passo2" class="passo">
                    <div class="box-resumo">
                        <h4>Total a pagar:</h4>
                        <div class="valor-destaque" id="valorModalPagamento">R$ 0,00</div>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;" id="numerosModalPagamento">N√∫meros: --</p>
                    </div>

                    <div class="box-pix">
                        <p>Copie a chave abaixo e fa√ßa o PIX:</p>
                        <div class="chave-pix" id="textoChavePix">SUA_CHAVE_AQUI</div>
                        <button class="btn-copiar" id="btnCopiarPix">üìã Copiar Chave PIX</button>
                    </div>

                    <p style="font-size: 0.85rem; text-align: center; color: #666; margin-bottom: 15px;">
                        Ap√≥s o pagamento, clique no bot√£o abaixo para nos enviar o comprovante no WhatsApp.
                    </p>

                    <button class="btn-primario" style="width: 100%;" id="btnFinalizarReserva">J√° paguei, enviar comprovante!</button>
                    <button class="btn-voltar-passo" id="btnVoltarPasso1">Voltar e editar dados</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =========================================
            // CONFIGURA√á√ïES GERAIS E SUPABASE
            // =========================================
            const CHAVE_PIX = "889999465376"; 
            const TELEFONE_WHATSAPP = "5588999465376"; 
            const VALOR_POR_PONTO = 3;
            
            const supabaseUrl = "https://iysgablefbfefytouecp.supabase.co";
            const supabaseKey = "sb_publishable_Y8TSowvn_dCl3JjRnQ3E2A_N8sL6v_T";
            const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

            const gridNumeros = document.getElementById('gridNumeros');
            const totalSelecionadoEl = document.getElementById('totalSelecionado');
            const btnAbrirModal = document.getElementById('btnAbrirModal');
            const modalOverlay = document.getElementById('modalOverlay');
            const fecharModalBtn = document.getElementById('fecharModal');
            const modalTitulo = document.getElementById('modalTitulo');
            const passo1 = document.getElementById('passo1');
            const passo2 = document.getElementById('passo2');
            const nomeClienteInput = document.getElementById('nomeCliente');
            const telefoneClienteInput = document.getElementById('telefoneCliente');
            const btnAvancarPagamento = document.getElementById('btnAvancarPagamento');
            const btnVoltarPasso1 = document.getElementById('btnVoltarPasso1');
            const valorModalPagamento = document.getElementById('valorModalPagamento');
            const numerosModalPagamento = document.getElementById('numerosModalPagamento');
            const btnCopiarPix = document.getElementById('btnCopiarPix');
            const textoChavePix = document.getElementById('textoChavePix');
            const btnFinalizarReserva = document.getElementById('btnFinalizarReserva');
            const telaCarregamento = document.getElementById('telaCarregamento');

            textoChavePix.innerText = CHAVE_PIX;

            // =========================================
            // M√ÅSCARA DO TELEFONE
            // =========================================
            telefoneClienteInput.addEventListener('input', function (e) {
                // Remove tudo que n√£o √© n√∫mero
                let x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/);
                // Aplica o formato (00) 00000-0000
                e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
            });

            // =========================================
            // GERA√á√ÉO DOS N√öMEROS E BUSCA NO BANCO
            // =========================================
            for (let i = 1; i <= 200; i++) {
                const btn = document.createElement('button');
                btn.classList.add('numero', 'livre');
                const numFormatado = i.toString().padStart(3, '0');
                btn.innerText = numFormatado;
                btn.id = `btn-numero-${numFormatado}`; 
                gridNumeros.appendChild(btn);
            }

            const botoesNumeros = document.querySelectorAll('.numero');

            async function carregarStatusDoBanco() {
                try {
                    const { data, error } = await supabaseClient.from('numeros').select('*');
                    if (error) throw error;

                    if (data) {
                        data.forEach(registro => {
                            const numStr = String(registro.numero).padStart(3, '0');
                            const botao = document.getElementById(`btn-numero-${numStr}`);

                            if (botao) {
                                // Trava de Seguran√ßa dupla
                                if (registro.status === 'pago' || registro.status === 'vendido') {
                                    botao.className = 'numero pago';
                                } else if (registro.status === 'reservado') {
                                    botao.className = 'numero reservado';
                                }
                            }
                        });
                    }
                } catch (err) {
                    console.error('Falha de conex√£o:', err);
                } finally {
                    // Independente de dar erro ou sucesso, tira a tela de carregamento para liberar o site
                    telaCarregamento.style.display = 'none';
                }
            }

            // =========================================
            // INTERA√á√ÉO E C√ÅLCULOS
            // =========================================
            function atualizarResumo() {
                const selecionados = document.querySelectorAll('.numero.selecionado');
                const qtd = selecionados.length;
                const total = qtd * VALOR_POR_PONTO;
                totalSelecionadoEl.innerText = `${qtd} n√∫meros | R$ ${total},00`;
                
                valorModalPagamento.innerText = `R$ ${total},00`;
                const arrayNumeros = Array.from(selecionados).map(b => b.innerText);
                numerosModalPagamento.innerText = `N√∫meros: ${arrayNumeros.join(', ')}`;
            }

            botoesNumeros.forEach(botao => {
                botao.addEventListener('click', () => {
                    if (botao.classList.contains('pago') || botao.classList.contains('reservado')) return;
                    botao.classList.toggle('selecionado');
                    botao.classList.toggle('livre');
                    atualizarResumo();
                });
            });

            // =========================================
            // L√ìGICA DO MODAL
            // =========================================
            btnAbrirModal.addEventListener('click', () => {
                if (document.querySelectorAll('.numero.selecionado').length === 0) {
                    alert('Selecione pelo menos um n√∫mero livre para comprar.');
                    return;
                }
                passo1.classList.add('ativo');
                passo2.classList.remove('ativo');
                modalTitulo.innerText = "Seus Dados";
                modalOverlay.classList.add('ativo');
            });

            fecharModalBtn.addEventListener('click', () => modalOverlay.classList.remove('ativo'));

            btnAvancarPagamento.addEventListener('click', () => {
                if (!nomeClienteInput.value.trim() || telefoneClienteInput.value.replace(/\D/g, '').length < 10) {
                    alert('Preencha seu nome e um WhatsApp v√°lido com DDD!');
                    return;
                }
                passo1.classList.remove('ativo');
                passo2.classList.add('ativo');
                modalTitulo.innerText = "Pagamento via PIX";
            });

            btnVoltarPasso1.addEventListener('click', () => {
                passo2.classList.remove('ativo');
                passo1.classList.add('ativo');
                modalTitulo.innerText = "Seus Dados";
            });

            btnCopiarPix.addEventListener('click', () => {
                navigator.clipboard.writeText(CHAVE_PIX).then(() => {
                    btnCopiarPix.innerText = "‚úÖ Chave Copiada!";
                    btnCopiarPix.style.backgroundColor = "#28a745";
                    btnCopiarPix.style.color = "#fff";
                    setTimeout(() => {
                        btnCopiarPix.innerText = "üìã Copiar Chave PIX";
                        btnCopiarPix.style.backgroundColor = "#ffc107";
                        btnCopiarPix.style.color = "#000";
                    }, 3000);
                });
            });

            // =========================================
            // GRAVA√á√ÉO NO BANCO E REDIRECIONAMENTO
            // =========================================
            btnFinalizarReserva.addEventListener('click', async () => {
                const nome = nomeClienteInput.value.trim();
                const telefone = telefoneClienteInput.value.trim();
                const selecionados = document.querySelectorAll('.numero.selecionado');
                const numerosEscolhidos = Array.from(selecionados).map(botao => botao.innerText);
                const total = selecionados.length * VALOR_POR_PONTO;

                btnFinalizarReserva.innerText = "Processando e abrindo WhatsApp...";
                btnFinalizarReserva.disabled = true;

                try {
                    const { error } = await supabaseClient
                        .from('numeros')
                        .update({ status: 'reservado', nome_cliente: nome, telefone_cliente: telefone })
                        .in('numero', numerosEscolhidos);

                    if (error) throw error;

                    const mensagem = `‚úÖ *PAGAMENTO REALIZADO*\n\n` +
                                     `Ol√°! Fiz o pagamento da rifa.\n` +
                                     `*Nome:* ${nome}\n` +
                                     `*N√∫meros escolhidos:* ${numerosEscolhidos.join(', ')}\n` +
                                     `*Total:* R$ ${total},00\n\n` +
                                     `Segue o meu comprovante abaixo! üßæ`;
                    
                    const mensagemCodificada = encodeURIComponent(mensagem);
                    window.open(`https://wa.me/${TELEFONE_WHATSAPP}?text=${mensagemCodificada}`, '_blank');

                    setTimeout(() => { window.location.reload(); }, 800);

                } catch (err) {
                    console.error('Erro ao salvar no Supabase:', err);
                    alert('Erro ao processar sua reserva. Tente novamente.');
                    btnFinalizarReserva.innerText = "J√° paguei, enviar comprovante!";
                    btnFinalizarReserva.disabled = false;
                }
            });

            // Chama a fun√ß√£o que inicia tudo e bloqueia a tela enquanto carrega
            carregarStatusDoBanco();
        });
    </script>
</body>
</html>